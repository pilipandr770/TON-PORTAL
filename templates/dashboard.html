<!-- file: templates/dashboard.html -->
{% extends "base.html" %}
{% block content %}
<h1>Dashboard</h1>

<div class="card" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #36d7b7;">
  <h3 style="color: #36d7b7;">🔗 Schritt 1: Wallet verbinden</h3>
  <p style="margin-bottom: 16px; line-height: 1.8;">
    Verbinde deine TON-Wallet über das sichere <strong>TonConnect-Protokoll</strong>. 
    Wir verwahren <strong>keine Gelder</strong> und haben <strong>keinen Zugriff</strong> auf deine Private Keys. 
    Alle Transaktionen werden nur in deiner eigenen Wallet signiert.
  </p>
  
  <!-- Warnung über Bridge-Probleme -->
  <div id="bridge-warning" style="display:none; background:#3a1a1a; border:2px solid #f90; padding:12px; margin:10px 0; border-radius:8px;">
    <p style="margin:0; color:#f90;">
      ⚠️ <strong>WebSocket Bridge nicht verfügbar</strong><br>
      <span style="font-size:0.9em; color:#ccc;">
        Wenn die Verbindung nicht funktioniert, versuche den <a href="/dashboard-direct" style="color:#0af;">alternativen Modus</a> oder verwende VPN.
      </span>
    </p>
  </div>
  
  <!-- TonConnect UI zeichnet hier Button (mit Icon) und öffnet Modal mit QR -->
  <div id="tonconnect-ui-button"></div>
  
  <p id="wallet-status" style="margin-top:10px">Noch nicht verbunden.</p>
  
  <div style="margin-top: 16px; padding: 12px; background: #0d1117; border-radius: 8px; font-size: 0.9em; color: #888;">
    💡 <strong>Unterstützte Wallets:</strong> Tonkeeper, Tonhub, MyTonWallet, OpenMask und alle TonConnect-kompatiblen Wallets.
  </div>
</div>

<div class="card">
  <h3 style="color: #36d7b7;">💰 Schritt 2: Balance prüfen</h3>
  <p><strong>Adresse:</strong> <span id="addr">—</span></p>
  <p><strong>Netzwerk:</strong> <span id="net">—</span></p>
  <p><strong>Balance:</strong> <span id="bal">—</span> TON</p>
  <button id="btn-refresh" class="btn btn-secondary" disabled>Aktualisieren</button>
  
  <div style="margin-top: 16px; padding: 12px; background: #1a1a1a; border-left: 4px solid #ffd700; border-radius: 4px; font-size: 0.9em;">
    ⚠️ <strong>Mindestbetrag beachten:</strong> Verschiedene Pools haben unterschiedliche Minimum-Stakes 
    (z.B. 1 TON für Bemo, 50 TON für TON Whales). Prüfe die Pool-Details auf der 
    <a href="{{ url_for('pools') }}" style="color: #36d7b7;">Pools-Seite</a>.
  </div>
</div>

<div class="card" style="border: 2px solid #ffd700;">
  <h3 style="color: #ffd700;">🚀 Schritt 3: Pool wählen & Staking starten</h3>
  <p style="line-height: 1.8; margin-bottom: 16px;">
    Wähle einen Pool aus unserem kuratierten Katalog und gib den gewünschten Betrag ein. 
    Die Delegation wird <strong>nur in deiner Wallet</strong> signiert – wir haben keinen Zugriff auf deine Coins. 
    Nach der Bestätigung beginnt das Staking automatisch.
  </p>

  <div class="stake-form">
    <div class="form-group">
      <label for="pool-select"><strong>Pool</strong></label>
      <select id="pool-select" class="form-control">
        <option value="">— Pool wählen —</option>
      </select>
      <small id="pool-meta" class="form-hint"></small>
    </div>
    
    <div class="form-group">
      <label for="stake-amount"><strong>Menge (TON)</strong></label>
      <input id="stake-amount" type="number" step="0.01" min="0" 
             placeholder="z.B. 10" class="form-control"/>
    </div>
    
    <div class="form-group">
      <button id="btn-stake" class="btn" disabled>Delegieren</button>
    </div>
  </div>

  <div id="stake-result" class="stake-result"></div>
</div>

<div class="card">
  <h3>Staking / Pools</h3>
  <p>Vollständiger Katalog: <a href="{{ url_for('pools_page') }}">Pools</a></p>
  <p>Delegationen werden ausschließlich in deinem Wallet signiert. Keine Verwahrung durch diese Plattform.</p>
</div>

<script>
  function initDashboardUI() {
    if (!window.TonUI) {
      // TonUI nicht geladen, versuche es später
      setTimeout(initDashboardUI, 100);
      return;
    }
    
    window.TonUI.initDashboard();

    // Pool-Liste in Select laden
    fetch('/api/pools')
      .then(r => r.json())
      .then(data => {
        const sel = document.getElementById('pool-select');
        if (!data.items) return;
        
        data.items.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.address;
          opt.textContent = `${p.name} (${p.min_stake_ton} TON min, Fee ${(p.fee*100).toFixed(1)}%)`;
          opt.dataset.url = p.url || '';
          opt.dataset.min = p.min_stake_ton || 0;
          sel.appendChild(opt);
        });
      })
      .catch(err => {
        console.error('Error loading pools:', err);
      });

    const sel = document.getElementById('pool-select');
    const amount = document.getElementById('stake-amount');
    const btnStake = document.getElementById('btn-stake');
    const meta = document.getElementById('pool-meta');

    function validate() {
      const addr = sel.value;
      const val = parseFloat(amount.value || '0');
      const min = parseFloat(sel.selectedOptions[0]?.dataset?.min || '0');
      const ok = addr && val > 0 && val >= min;
      btnStake.disabled = !ok;
      
      if (addr) {
        meta.textContent = `Min Stake: ${min} TON`;
        meta.className = 'form-hint';
      } else {
        meta.textContent = '';
      }
      
      if (addr && val > 0 && val < min) {
        meta.textContent = `⚠️ Mindestens ${min} TON erforderlich`;
        meta.className = 'form-hint error';
      }
    }

    sel.addEventListener('change', validate);
    amount.addEventListener('input', validate);

    btnStake.addEventListener('click', async () => {
      const poolAddr = sel.value;
      const valTon = parseFloat(amount.value || '0');
      const result = document.getElementById('stake-result');
      result.textContent = '⏳ Sende Transaktion...';
      result.className = 'stake-result';
      
      try {
        const ok = await window.TonUI.sendStake(poolAddr, valTon);
        if (ok) {
          const user = document.getElementById('addr').textContent;
          const viewer = `https://tonviewer.com/${encodeURIComponent(user)}?section=transactions`;
          result.innerHTML = `✅ Transaktion gesendet! <a href="${viewer}" target="_blank" rel="noopener">Verlauf ansehen →</a>`;
          result.className = 'stake-result success';
          
          // Formular zurücksetzen
          amount.value = '';
          validate();
          
          // Balance nach 3 Sekunden aktualisieren
          setTimeout(() => {
            const btnRefresh = document.getElementById('btn-refresh');
            if (btnRefresh && !btnRefresh.disabled) {
              btnRefresh.click();
            }
          }, 3000);
        } else {
          result.textContent = '❌ Transaktion abgebrochen oder fehlgeschlagen.';
          result.className = 'stake-result error';
        }
      } catch (e) {
        console.error(e);
        result.textContent = '❌ Fehler beim Senden: ' + e.message;
        result.className = 'stake-result error';
      }
    });
  }
  
  // Initialisierung nach DOM-Laden starten
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDashboardUI);
  } else {
    initDashboardUI();
  }
  
  // Automatische WebSocket Bridge Verfügbarkeitsprüfung
  setTimeout(() => {
    try {
      const testWs = new WebSocket('wss://bridge.tonapi.io/bridge');
      const timeout = setTimeout(() => {
        document.getElementById('bridge-warning').style.display = 'block';
        testWs.close();
      }, 3000);
      
      testWs.onopen = () => {
        clearTimeout(timeout);
        testWs.close();
        console.log('✅ Bridge verfügbar');
      };
      
      testWs.onerror = () => {
        clearTimeout(timeout);
        document.getElementById('bridge-warning').style.display = 'block';
      };
    } catch (e) {
      document.getElementById('bridge-warning').style.display = 'block';
    }
  }, 2000);
</script>
{% endblock %}
