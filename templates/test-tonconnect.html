<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TonConnect Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0f1520;
            color: white;
        }
        .card {
            background: #1a2332;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log div {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0af; }
        .warning { color: #fa0; }
    </style>
</head>
<body>
    <h1>üîç TonConnect –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    
    <div class="card">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h3>
        <p id="lib-check">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</p>
    </div>
    
    <div class="card">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Manifest</h3>
        <p id="manifest-check">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</p>
    </div>
    
    <div class="card">
        <h3>3. –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div id="tonconnect-ui-button"></div>
    </div>
    
    <div class="card">
        <h3>4. –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="wallet-status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></p>
        <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="addr">‚Äî</span></p>
        <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span id="bal">‚Äî</span> TON</p>
    </div>
    
    <div class="log" id="log"></div>

    <!-- TonConnect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js" 
            crossorigin="anonymous" 
            onload="window.tonConnectLoaded = true; console.log('Script loaded')"
            onerror="window.tonConnectError = true; console.log('Script error')"></script>
    
    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            try {
                const div = document.createElement('div');
                div.className = type;
                div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
                console.log(message);
            } catch (e) {
                console.error('Log error:', e);
            }
        }
        
        addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
        addLog('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
        addLog('UserAgent: ' + navigator.userAgent, 'info');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ (—Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏)
        let checkAttempt = 0;
        const maxAttempts = 30;
        
        function checkLibrary() {
            checkAttempt++;
            addLog(`–ü–æ–ø—ã—Ç–∫–∞ ${checkAttempt}/${maxAttempts}: –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏...`, 'info');
            
            const libCheck = document.getElementById('lib-check');
            
            if (window.tonConnectError) {
                libCheck.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –∏–∑ CDN';
                libCheck.style.color = '#f00';
                addLog('‚ùå CDN unpkg.com –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!', 'error');
                addLog('   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ VPN', 'warning');
                return;
            }
            
            if (window.TON_CONNECT_UI) {
                libCheck.innerHTML = '‚úÖ window.TON_CONNECT_UI –Ω–∞–π–¥–µ–Ω–∞';
                libCheck.style.color = '#0f0';
                addLog('‚úÖ TonConnect UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                checkManifest();
            } else if (window.TonConnectUI) {
                libCheck.innerHTML = '‚úÖ window.TonConnectUI –Ω–∞–π–¥–µ–Ω–∞';
                libCheck.style.color = '#0f0';
                addLog('‚úÖ TonConnect UI (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è) –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                checkManifest();
            } else if (checkAttempt < maxAttempts) {
                libCheck.innerHTML = `‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ... (${checkAttempt}/${maxAttempts})`;
                setTimeout(checkLibrary, 500);
            } else {
                libCheck.innerHTML = '‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ—Å–ª–µ ' + maxAttempts + ' –ø–æ–ø—ã—Ç–æ–∫';
                libCheck.style.color = '#f00';
                addLog('‚ùå TonConnect UI –ù–ï –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ—Å–ª–µ ' + maxAttempts + ' –ø–æ–ø—ã—Ç–æ–∫!', 'error');
                addLog('   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', 'warning');
                addLog('   1. –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
                addLog('   2. CDN unpkg.com –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
                addLog('   3. CSP –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–∞', 'warning');
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(checkLibrary, 1000);
        
        function checkManifest() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Manifest
            const manifestUrl = window.location.origin + '/tonconnect-manifest.json';
            addLog('üìÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ manifest: ' + manifestUrl, 'info');
            
            const manifestCheck = document.getElementById('manifest-check');
            
            fetch(manifestUrl)
                .then(r => {
                    if (r.ok) {
                        manifestCheck.innerHTML = '‚úÖ Manifest –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP ' + r.status + ')';
                        manifestCheck.style.color = '#0f0';
                        addLog('‚úÖ Manifest –¥–æ—Å—Ç—É–ø–µ–Ω: HTTP ' + r.status, 'success');
                        return r.json();
                    } else {
                        throw new Error('HTTP ' + r.status);
                    }
                })
                .then(manifest => {
                    addLog('‚úÖ Manifest –∑–∞–≥—Ä—É–∂–µ–Ω: ' + manifest.name, 'success');
                    addLog('   URL –≤ manifest: ' + manifest.url, 'info');
                    addLog('   –¢–µ–∫—É—â–∏–π URL: ' + window.location.origin, 'info');
                    
                    if (manifest.url !== window.location.origin) {
                        addLog('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: URL –≤ manifest –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç!', 'warning');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TonConnect
                    initTonConnect();
                })
                .catch(err => {
                    manifestCheck.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + err.message;
                    manifestCheck.style.color = '#f00';
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ manifest: ' + err.message, 'error');
                    addLog('   Manifest –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:', 'info');
                    addLog('   ' + manifestUrl, 'info');
                });
        }
        
        function initTonConnect() {
            addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TonConnect UI...', 'info');
            
            const TonConnectUIClass = window.TON_CONNECT_UI?.TonConnectUI || window.TonConnectUI;
            
            try {
                const tonConnectUI = new TonConnectUIClass({
                    manifestUrl: window.location.origin + '/tonconnect-manifest.json',
                    buttonRootId: 'tonconnect-ui-button'
                });
                
                addLog('‚úÖ TonConnect UI —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                addLog('   Connected: ' + tonConnectUI.connected, 'info');
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                tonConnectUI.onStatusChange(async (walletInfo) => {
                    addLog('üîî onStatusChange –≤—ã–∑–≤–∞–Ω!', 'warning');
                    addLog('   walletInfo: ' + JSON.stringify(walletInfo), 'info');
                    
                    if (walletInfo && walletInfo.account) {
                        const address = walletInfo.account.address;
                        addLog('‚úÖ –ö–û–®–ï–õ–ï–ö –ü–û–î–ö–õ–Æ–ß–ï–ù!', 'success');
                        addLog('   –ê–¥—Ä–µ—Å: ' + address, 'success');
                        
                        document.getElementById('wallet-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                        document.getElementById('addr').textContent = address;
                        
                        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
                        addLog('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞...', 'info');
                        try {
                            const res = await fetch(`/api/balance/${address}`);
                            const data = await res.json();
                            
                            if (data && !data.error) {
                                document.getElementById('bal').textContent = data.balance_ton.toFixed(4);
                                addLog('‚úÖ –ë–∞–ª–∞–Ω—Å: ' + data.balance_ton + ' TON', 'success');
                            } else {
                                addLog('‚ùå –û—à–∏–±–∫–∞ API –±–∞–ª–∞–Ω—Å–∞: ' + data.error, 'error');
                            }
                        } catch (e) {
                            addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞: ' + e.message, 'error');
                        }
                    } else {
                        addLog('‚ùå –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
                        document.getElementById('wallet-status').textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                        document.getElementById('addr').textContent = '‚Äî';
                        document.getElementById('bal').textContent = '‚Äî';
                    }
                });
                
                addLog('‚úÖ onStatusChange –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                tonConnectUI.connectionRestored.then(restored => {
                    addLog('connectionRestored: ' + restored, 'info');
                });
                
            } catch (error) {
                addLog('‚ùå –û–®–ò–ë–ö–ê –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
                addLog('   Stack: ' + error.stack, 'error');
            }
        }
    </script>
</body>
</html>
